function doGet(e) {
  // Navigasi halaman berdasarkan parameter URL ?page=dashboard
  if (e.parameter.page == 'dashboard') {
    return HtmlService.createHtmlOutputFromFile('dashboard')
        .setTitle('Dashboard Pengelola - Klasis Makale Utara')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
  
  // Halaman default (Portal Depan)
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('Portal Survey Klasis Makale Utara')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Fungsi untuk mendapatkan URL Web App secara dinamis untuk login admin
function getScriptUrl() {
  return ScriptApp.getService().getUrl();
}

function processForm(payload) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = payload.asalJemaat;
    let sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      return "Error: Sheet untuk Jemaat " + sheetName + " tidak ditemukan.";
    }

    // --- LOGIKA PENENTUAN KOLOM (D-M / Responden 1-10) ---
    // Mencari kolom kosong berdasarkan baris ke-4 (Soal No. 1)
    let targetCol = -1;
    for (let col = 4; col <= 13; col++) {
      if (sheet.getRange(4, col).getValue() === "") {
        targetCol = col;
        break;
      }
    }

    if (targetCol === -1) {
      return "Maaf, kuota 10 responden untuk jemaat ini sudah penuh.";
    }

    // Beri label Responden di baris 2
    sheet.getRange(2, targetCol).setValue("Responden " + (targetCol - 3));

    // Masukkan jawaban ke baris yang sesuai (ID Pertanyaan + 3)
    payload.answers.forEach(item => {
      if (item.id) {
        const row = parseInt(item.id) + 3; // Soal 1 ada di baris 4
        
        // Simpan jawaban pilihan (a/b/c)
        if (item.ans) {
          sheet.getRange(row, targetCol).setValue(item.ans);
        }
        
        // Simpan jawaban tambahan di kolom C (index 3) jika ada
        if (item.extra) {
          sheet.getRange(row, 3).setValue(item.extra);
        }
      }
    });

    return "Sukses"; 
    
  } catch (e) {
    return "Terjadi kesalahan: " + e.toString();
  }
}
