<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .page { display: none; } .active { display: block; }
    .question-block { background: #f8f9fa; padding: 15px; border-left: 5px solid #1b5e20; margin-bottom: 15px; border-radius: 5px; }
    .extra-field { display: none; background: #fffde7; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body class="p-3">
  <div id="tutorial" class="modal-overlay">
    <div class="bg-white p-4 rounded shadow" style="max-width: 450px;">
      <h4>Panduan Survey</h4>
      <ul>
        <li>Pilih Jemaat di awal.</li>
        <li>Isi 10 soal per halaman (Total 99).</li>
        <li>Tunggu download bukti PDF di akhir.</li>
      </ul>
      <button class="btn btn-success w-100" onclick="closeTut()">SAYA MENGERTI</button>
    </div>
  </div>

  <div class="container bg-white p-4 rounded shadow-sm" style="max-width: 800px;">
    <div id="page0" class="page active text-center">
      <h3>Pilih Jemaat</h3>
      <select id="asalJemaat" class="form-select my-4">
        <option value="">-- Pilih Jemaat --</option>
        <option>Jemaat Silo Barani</option>
        <option>Jemaat Rantelemo</option>
        </select>
      <button class="btn btn-primary px-5" onclick="nextPage(1)">Mulai</button>
    </div>

    <form id="surveyForm">
      <div id="questionsContainer"></div>
      <div id="pageFinal" class="page text-center">
        <h3>Hampir Selesai!</h3>
        <p>Klik tombol di bawah untuk menyimpan data dan mengunduh bukti.</p>
        <button type="button" id="btnSubmit" class="btn btn-success btn-lg" onclick="kirimSurvey()">KIRIM JAWABAN</button>
      </div>
    </form>
  </div>

  <script>
    const qData = [ /* MASUKKAN DATA PERTANYAAN ANDA DI SINI */ ];
    let currentPage = 0;
    const qPerPage = 10;
    const totalPages = Math.ceil(qData.length / qPerPage);

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      for (let p = 1; p <= totalPages; p++) {
        const div = document.createElement('div');
        div.id = `page${p}`; div.className = 'page';
        const start = (p-1)*qPerPage;
        const end = Math.min(start+qPerPage, qData.length);
        let html = `<p class="text-end">Halaman ${p}/${totalPages}</p>`;
        for (let i = start; i < end; i++) {
          const q = qData[i];
          html += `<div class="question-block">
            <p><b>${q.id}. ${q.q}</b></p>`;
          if(q.opt) q.opt.forEach((o, idx) => {
            html += `<div class="form-check"><input class="form-check-input" type="radio" name="q${q.id}" value="${o}" onclick="checkEx(${q.id},'${String.fromCharCode(97+idx)}','${q.branchOn}')"><label class="form-check-label">${o}</label></div>`;
          });
          if(q.type === 'branch') html += `<div id="extra_${q.id}" class="extra-field"><label class="small">${q.branchQ}</label><input type="text" name="q${q.id}_ex" class="form-control"></div>`;
          if(q.type === 'input') html += `<textarea name="q${q.id}_text" class="form-control"></textarea>`;
          html += `</div>`;
        }
        html += `<div class="d-flex justify-content-between"><button type="button" class="btn btn-secondary" onclick="prevPage()">Kembali</button><button type="button" class="btn btn-primary" onclick="nextPage(${p+1})">Lanjut</button></div>`;
        div.innerHTML = html; container.appendChild(div);
      }
    }

    function closeTut() { document.getElementById('tutorial').style.display='none'; }
    function checkEx(id, val, target) { let el = document.getElementById(`extra_${id}`); if(el) el.style.display = (val === target) ? 'block' : 'none'; }
    function nextPage(n) { 
      if(currentPage === 0 && !document.getElementById('asalJemaat').value) return alert("Pilih jemaat!");
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      currentPage = n;
      const tid = (n > totalPages) ? 'pageFinal' : `page${n}`;
      document.getElementById(tid).classList.add('active');
      window.scrollTo(0,0);
    }
    function prevPage() { currentPage--; nextPage(currentPage); }

    function kirimSurvey() {
      const btn = document.getElementById('btnSubmit'); btn.disabled = true; btn.innerText = "Mengirim...";
      const fd = new FormData(document.getElementById('surveyForm'));
      const payload = { asalJemaat: document.getElementById('asalJemaat').value, answers: [] };
      qData.forEach(q => { payload.answers.push({ id: q.id, ans: fd.get(`q${q.id}`), extra: fd.get(`q${q.id}_ex`), text: fd.get(`q${q.id}_text`) }); });

      google.script.run.withSuccessHandler(res => {
        if(res === "Sukses") {
          google.script.run.withSuccessHandler(pdf => {
            const a = document.createElement('a'); a.href = pdf; a.download = "Bukti.pdf"; a.click();
            google.script.run.withSuccessHandler(url => window.location.href = url + "?page=dashboard").getScriptUrl();
          }).generatePDF(payload);
        } else alert(res);
      }).processForm(payload);
    }
    window.onload = renderQuestions;
  </script>
</body>
</html>